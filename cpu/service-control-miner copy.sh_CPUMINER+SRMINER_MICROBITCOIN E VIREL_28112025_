#!/bin/bash

# Script para compilar e executar cpuminer-opt e SRBMiner
set -e

# ============================================================================
# CONFIGURAÇÕES GERAIS
# ============================================================================

# Configurações do cpuminer
CPUMINER_DIR="/home/wendell/cpuminer-opt"
CPUMINER_PATH="$CPUMINER_DIR/cpuminer"
POOL_CPUMINER="stratum+tcp://na.rplant.xyz:7022"
WALLET_CPUMINER="Bqd2qXoeBNsnfhMPDxXVKc9UzoqD7B5EqK"
ALGO_CPUMINER="power2b"
WORKER_NAME="$(hostname)"

# Configurações do SRBMiner
SRB_DIR="/home/wendell/SRBMiner"
SRB_PATH="$SRB_DIR/SRBMiner-Multi-2-9-8/SRBMiner-MULTI"
POOL_SRB="stratum-na.rplant.xyz:7155"
WALLET_SRB="v1em8ehwjlda71d98crfii0glji3rtdjboejdqe"
ALGO_SRB="randomvirel"

# Configurações de log
LOG_DIR="/home/wendell/logs"
CPUMINER_LOGFILE="$LOG_DIR/cpuminer.log"
SRB_LOGFILE="$LOG_DIR/srbminer.log"
ENV_LOGFILE="$LOG_DIR/start-env.log"
ERROR_LOGFILE="$LOG_DIR/error.log"

# Threads
TOTAL_THREADS=$(nproc)
THREADS_CPUMINER=$((TOTAL_THREADS / 2))
THREADS_SRB=$((TOTAL_THREADS - THREADS_CPUMINER))

# ============================================================================
# INICIALIZAÇÃO
# ============================================================================

# Criar diretório de logs
mkdir -p "$LOG_DIR"

# Criar arquivos de log
for logfile in "$CPUMINER_LOGFILE" "$SRB_LOGFILE" "$ENV_LOGFILE" "$ERROR_LOGFILE"; do
    touch "$logfile"
    chmod 644 "$logfile"
done

# Log de ambiente
env >> "$ENV_LOGFILE"
echo "$(date): Iniciando processo com $TOTAL_THREADS threads totais" >> "$ENV_LOGFILE"
echo "$(date): CPUMiner: $THREADS_CPUMINER threads" >> "$ENV_LOGFILE"
echo "$(date): SRBMiner: $THREADS_SRB threads" >> "$ENV_LOGFILE"

# ============================================================================
# INSTALAÇÃO DO CPUMINER
# ============================================================================

echo "$(date): Verificando cpuminer..." >> "$CPUMINER_LOGFILE"

if [ ! -f "$CPUMINER_PATH" ]; then
    echo "CPUMiner não encontrado. Instalando dependências e compilando..." >> "$CPUMINER_LOGFILE"
    
    # Atualizar e instalar dependências
    echo "Instalando dependências..." >> "$CPUMINER_LOGFILE"
    sudo apt-get update >> "$CPUMINER_LOGFILE" 2>&1
    sudo apt-get install -y build-essential automake libssl-dev libcurl4-openssl-dev libjansson-dev libgmp-dev zlib1g-dev git >> "$CPUMINER_LOGFILE" 2>&1
    
    # Clonar e compilar cpuminer
    echo "Clonando repositório do cpuminer..." >> "$CPUMINER_LOGFILE"
    cd /home/wendell/
    
    # Remove diretório existente se houver
    rm -rf cpuminer-opt
    
    git clone https://github.com/JayDDee/cpuminer-opt.git >> "$CPUMINER_LOGFILE" 2>&1
    cd cpuminer-opt
    
    echo "Compilando cpuminer..." >> "$CPUMINER_LOGFILE"
    ./build.sh >> "$CPUMINER_LOGFILE" 2>&1
    
    # Verificar se a compilação foi bem sucedida
    if [ ! -f "cpuminer" ]; then
        echo "ERRO: Falha ao compilar cpuminer" >> "$CPUMINER_LOGFILE"
        exit 1
    fi
    
    echo "CPUMiner compilado com sucesso!" >> "$CPUMINER_LOGFILE"
else
    echo "CPUMiner já está instalado." >> "$CPUMINER_LOGFILE"
fi

# Verificar se é executável
chmod +x "$CPUMINER_PATH"

# ============================================================================
# INSTALAÇÃO DO SRBMINER
# ============================================================================

echo "$(date): Verificando SRBMiner..." >> "$SRB_LOGFILE"

# Verifica existência do SRBMiner
if [ ! -f "$SRB_PATH" ]; then
    echo "SRBMiner não encontrado. Baixando versão 2.9.8..." >> "$ERROR_LOGFILE"
    mkdir -p "$SRB_DIR" && cd "$SRB_DIR" || exit 1
    
    # Remove versões antigas se existirem
    rm -rf SRBMiner-Multi-* srbminer_custom-*
    
    # Baixa a versão mais recente 2.9.8
    echo "Baixando SRBMiner 2.9.8..." >> "$SRB_LOGFILE"
    wget https://github.com/doktor83/SRBMiner-Multi/releases/download/2.9.8/SRBMiner-Multi-2-9-8-Linux.tar.gz
    
    # Extrai o arquivo
    echo "Extraindo SRBMiner..." >> "$SRB_LOGFILE"
    tar -xvf SRBMiner-Multi-2-9-8-Linux.tar.gz
    
    # Verifica se a extração foi bem sucedida
    if [ -f "$SRB_PATH" ]; then
        echo "SRBMiner 2.9.8 baixado e extraído com sucesso." >> "$ENV_LOGFILE"
        # Torna o executável
        chmod +x "$SRB_PATH"
    else
        echo "ERRO: SRBMiner não foi extraído corretamente." >> "$ERROR_LOGFILE"
        echo "Tentando encontrar o binário..." >> "$ERROR_LOGFILE"
        # Tenta encontrar o binário em subdiretórios
        FOUND_BINARY=$(find "$SRB_DIR" -name "SRBMiner-MULTI" -type f | head -1)
        if [ -n "$FOUND_BINARY" ]; then
            SRB_PATH="$FOUND_BINARY"
            chmod +x "$SRB_PATH"
            echo "Binário encontrado: $SRB_PATH" >> "$ENV_LOGFILE"
        else
            echo "ERRO: Não foi possível encontrar o binário do SRBMiner" >> "$ERROR_LOGFILE"
            exit 1
        fi
    fi
    
    # Limpa arquivo tar
    rm -f SRBMiner-Multi-2-9-8-Linux.tar.gz
else
    echo "SRBMiner 2.9.8 já está instalado." >> "$ENV_LOGFILE"
fi

# ============================================================================
# EXECUÇÃO DOS MINERADORES
# ============================================================================

echo "$(date): Iniciando ambos os mineradores..." >> "$ENV_LOGFILE"

# Inicia SRBMiner para moeda 1
echo "$(date): Iniciando mineração com SRBMiner 2.9.8..." >> "$SRB_LOGFILE"
echo "Comando: $SRB_PATH --disable-gpu --algorithm $ALGO_SRB --cpu-threads $THREADS_SRB --pool $POOL_SRB --wallet $WALLET_SRB.$WORKER_NAME --keepalive true" >> "$SRB_LOGFILE"

"$SRB_PATH" --disable-gpu --algorithm "$ALGO_SRB" --cpu-threads "$THREADS_SRB" \
--pool "$POOL_SRB" --wallet "$WALLET_SRB.$WORKER_NAME" \
--keepalive true \
>> "$SRB_LOGFILE" 2>> "$ERROR_LOGFILE" &

PID_SRB=$!
echo "$(date): SRBMiner iniciado com PID: $PID_SRB" >> "$ENV_LOGFILE"

# Pequena pausa para garantir que o SRBMiner inicializou
sleep 5

# Executar cpuminer
echo "$(date): Iniciando mineração com cpuminer..." >> "$CPUMINER_LOGFILE"
echo "Comando: $CPUMINER_PATH -a $ALGO_CPUMINER -o $POOL_CPUMINER -u $WALLET_CPUMINER.$WORKER_NAME -t $THREADS_CPUMINER" >> "$CPUMINER_LOGFILE"

"$CPUMINER_PATH" -a "$ALGO_CPUMINER" -o "$POOL_CPUMINER" -u "$WALLET_CPUMINER.$WORKER_NAME" -t "$THREADS_CPUMINER" \
>> "$CPUMINER_LOGFILE" 2>> "$ERROR_LOGFILE" &

PID_CPUMINER=$!
echo "$(date): CPUMiner iniciado com PID: $PID_CPUMINER" >> "$ENV_LOGFILE"

# ============================================================================
# MONITORAMENTO
# ============================================================================

echo "$(date): Ambos mineradores iniciados com sucesso!" >> "$ENV_LOGFILE"
echo "$(date): SRBMiner PID: $PID_SRB" >> "$ENV_LOGFILE"
echo "$(date): CPUMiner PID: $PID_CPUMINER" >> "$ENV_LOGFILE"

# Aguardar ambos os processos
wait $PID_SRB $PID_CPUMINER

echo "$(date): Ambos mineradores finalizaram." >> "$ENV_LOGFILE"