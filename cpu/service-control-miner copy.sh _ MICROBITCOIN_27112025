#!/bin/bash

# Script corrigido para cpuminer - SEM problemas de permissão
set -e

# Configurações
CPUMINER_PATH="/home/wendell/cpuminer-sse2"
POOL="stratum+tcp://na.rplant.xyz:7022"
WALLET="Bqd2qXoeBNsnfhMPDxXVKc9UzoqD7B5EqK"
ALGO="power2b"
WORKER_NAME="$(hostname)"

# Diretório de log no home do usuário (sem problemas de permissão)
LOG_DIR="/home/wendell/logs"
mkdir -p "$LOG_DIR"

# Log inicial
echo "$(date): Iniciando cpuminer..." >> "$LOG_DIR/cpuminer.log"

# Verificar e baixar cpuminer se necessário
if [ ! -f "$CPUMINER_PATH" ]; then
    echo "Baixando cpuminer..." >> "$LOG_DIR/cpuminer.log"
    cd /home/wendell/
    wget -q https://git.mmpos.eu/cpu-linux/cpuminer-opt-rplant/-/raw/master/cpuminer-sse2
    chmod +x cpuminer-sse2
    
    if [ ! -f "cpuminer-sse2" ]; then
        echo "ERRO: Falha ao baixar cpuminer" >> "$LOG_DIR/cpuminer.log"
        exit 1
    fi
fi

# Verificar se é executável
chmod +x "$CPUMINER_PATH"

# Executar cpuminer
echo "$(date): Executando cpuminer..." >> "$LOG_DIR/cpuminer.log"
exec "$CPUMINER_PATH" -a "$ALGO" -o "$POOL" -u "$WALLET.$WORKER_NAME"