#!/bin/bash

# ============================================================================
# CONFIGURAÇÕES GERAIS
# ============================================================================

# Caminho dos logs
MOEDA1_LOGFILE="/var/log/SRBMOEDA1.log"
MOEDA2_LOGFILE="/var/log/SRBMOEDA2.log"
ENV_LOGFILE="/var/log/start-env.log"
ERROR_LOGFILE="/var/log/error.log"

# Criar arquivos de log
for logfile in "$MOEDA1_LOGFILE" "$MOEDA2_LOGFILE" "$ENV_LOGFILE" "$ERROR_LOGFILE"; do
    touch "$logfile"
    chmod 644 "$logfile"
done

# Exporta PATH
export PATH="$PATH"

# Log de variáveis de ambiente
env >> "$ENV_LOGFILE"

# Threads - AFFINITY ESPECÍFICO
TOTAL_THREADS=$(nproc)
echo "$(date): Sistema com $TOTAL_THREADS threads" >> "$ENV_LOGFILE"

# Definir affinity específico para cada minerador
if [ $TOTAL_THREADS -eq 2 ]; then
    # 2 threads: 0 para minerador1, 1 para minerador2
    AFFINITY1="0"
    AFFINITY2="1"
elif [ $TOTAL_THREADS -eq 4 ]; then
    # 4 threads: 0,1 para minerador1 | 2,3 para minerador2
    AFFINITY1="0,1"
    AFFINITY2="2,3"
elif [ $TOTAL_THREADS -eq 6 ]; then
    # 6 threads: 0,1,2 para minerador1 | 3,4,5 para minerador2
    AFFINITY1="0,1,2"
    AFFINITY2="3,4,5"
elif [ $TOTAL_THREADS -eq 8 ]; then
    # 8 threads: 0,1,2,3 para minerador1 | 4,5,6,7 para minerador2
    AFFINITY1="0,1,2,3"
    AFFINITY2="4,5,6,7"
elif [ $TOTAL_THREADS -eq 12 ]; then
    # 12 threads: 0-5 para minerador1 | 6-11 para minerador2
    AFFINITY1="0,1,2,3,4,5"
    AFFINITY2="6,7,8,9,10,11"
elif [ $TOTAL_THREADS -eq 16 ]; then
    # 16 threads: 0-7 para minerador1 | 8-15 para minerador2
    AFFINITY1="0,1,2,3,4,5,6,7"
    AFFINITY2="8,9,10,11,12,13,14,15"
else
    # Configuração genérica para outros números de threads
    HALF_THREADS=$((TOTAL_THREADS / 2))
    AFFINITY1=$(seq -s, 0 $((HALF_THREADS - 1)))
    AFFINITY2=$(seq -s, $HALF_THREADS $((TOTAL_THREADS - 1)))
fi

echo "$(date): Affinity Minerador 1: CPUs $AFFINITY1" >> "$ENV_LOGFILE"
echo "$(date): Affinity Minerador 2: CPUs $AFFINITY2" >> "$ENV_LOGFILE"

# ============================================================================
# INSTALAÇÃO DO SRBMINER 3.0.5
# ============================================================================

# Caminho do binário SRBMiner (ATUALIZADO PARA VERSÃO 3.0.5)
SRB_PATH="/home/wendell/SRBMiner/SRBMiner-Multi-3-0-5/SRBMiner-MULTI"

# Verifica existência do SRBMiner (ATUALIZADO PARA VERSÃO 3.0.5)
if [ ! -f "$SRB_PATH" ]; then
    echo "$(date): SRBMiner não encontrado. Baixando versão 3.0.5..." >> "$ERROR_LOGFILE"
    mkdir -p /home/wendell/SRBMiner && cd /home/wendell/SRBMiner || exit 1
    
    # Remove versões antigas se existirem
    rm -rf SRBMiner-Multi-* srbminer_custom-*
    
    # Baixa a versão mais recente 3.0.5
    echo "$(date): Baixando SRBMiner 3.0.5..." >> "$ENV_LOGFILE"
    wget https://github.com/doktor83/SRBMiner-Multi/releases/download/3.0.5/SRBMiner-Multi-3-0-5-Linux.tar.gz
    
    # Extrai o arquivo
    echo "$(date): Extraindo SRBMiner 3.0.5..." >> "$ENV_LOGFILE"
    tar -xvf SRBMiner-Multi-3-0-5-Linux.tar.gz
    
    # Verifica se a extração foi bem sucedida
    if [ -f "$SRB_PATH" ]; then
        echo "$(date): SRBMiner 3.0.5 baixado e extraído com sucesso." >> "$ENV_LOGFILE"
        # Torna o executável
        chmod +x "$SRB_PATH"
        
        # Verificar se o algoritmo randomhscx está disponível
        echo "$(date): Verificando algoritmos disponíveis..." >> "$ENV_LOGFILE"
        "$SRB_PATH" --list-algorithms >> "$ENV_LOGFILE" 2>&1
    else
        echo "$(date): ERRO: SRBMiner não foi extraído corretamente." >> "$ERROR_LOGFILE"
        echo "$(date): Tentando encontrar o binário..." >> "$ERROR_LOGFILE"
        # Tenta encontrar o binário em subdiretórios
        FOUND_BINARY=$(find /home/wendell/SRBMiner -name "SRBMiner-MULTI" -type f | head -1)
        if [ -n "$FOUND_BINARY" ]; then
            SRB_PATH="$FOUND_BINARY"
            chmod +x "$SRB_PATH"
            echo "$(date): Binário encontrado: $SRB_PATH" >> "$ENV_LOGFILE"
        else
            echo "$(date): ERRO: Não foi possível encontrar o binário do SRBMiner" >> "$ERROR_LOGFILE"
            exit 1
        fi
    fi
    
    # Limpa arquivo tar
    rm -f SRBMiner-Multi-3-0-5-Linux.tar.gz
else
    echo "$(date): SRBMiner 3.0.5 já está instalado." >> "$ENV_LOGFILE"
fi

# ============================================================================
# CONFIGURAÇÕES DOS MINERADORES
# ============================================================================

# Primeira moeda (RandomHSCX)
MOEDA1_POOL="stratum-na.rplant.xyz:7023"
MOEDA1_WALLET="hx1qhhnxud9h3sa7l76a5rp8sk2x9fvsdgmt5e80ss"
MOEDA1_ALGO="randomhscx"

# Segunda moeda (RandomVIREL)
MOEDA2_POOL="stratum-na.rplant.xyz:7155"
MOEDA2_WALLET="v1em8ehwjlda71d98crfii0glji3rtdjboejdqe"
MOEDA2_ALGO="randomvirel"

# ============================================================================
# EXECUÇÃO DOS MINERADORES COM CPU AFFINITY
# ============================================================================

echo "$(date): Iniciando mineração com CPU affinity específico..." >> "$ENV_LOGFILE"

# Inicia SRBMiner para moeda 1 (RandomHSCX) - COM AFFINITY
echo "$(date): Iniciando mineração da Moeda 1 (RandomHSCX) com affinity: $AFFINITY1..." >> "$MOEDA1_LOGFILE"
echo "$(date): Comando: taskset -c $AFFINITY1 $SRB_PATH --disable-gpu --algorithm $MOEDA1_ALGO --pool $MOEDA1_POOL --wallet $MOEDA1_WALLET.$(hostname) --keepalive true" >> "$MOEDA1_LOGFILE"

taskset -c $AFFINITY1 "$SRB_PATH" --disable-gpu --algorithm "$MOEDA1_ALGO" --cpu-threads $TOTAL_THREADS \
--pool "$MOEDA1_POOL" --wallet "$MOEDA1_WALLET.$(hostname)" \
--keepalive true \
>> "$MOEDA1_LOGFILE" 2>> "$ERROR_LOGFILE" &

PID1=$!
echo "$(date): SRBMiner Moeda 1 iniciado com PID: $PID1 (CPUs: $AFFINITY1)" >> "$ENV_LOGFILE"

# Pequena pausa para garantir que o primeiro minerador inicializou
sleep 5

# Inicia SRBMiner para moeda 2 (RandomVIREL) - COM AFFINITY
echo "$(date): Iniciando mineração da Moeda 2 (RandomVIREL) com affinity: $AFFINITY2..." >> "$MOEDA2_LOGFILE"
echo "$(date): Comando: taskset -c $AFFINITY2 $SRB_PATH --disable-gpu --algorithm $MOEDA2_ALGO --pool $MOEDA2_POOL --wallet $MOEDA2_WALLET.$(hostname) --keepalive true" >> "$MOEDA2_LOGFILE"

taskset -c $AFFINITY2 "$SRB_PATH" --disable-gpu --algorithm "$MOEDA2_ALGO" --cpu-threads $TOTAL_THREADS \
--pool "$MOEDA2_POOL" --wallet "$MOEDA2_WALLET.$(hostname)" \
--keepalive true \
>> "$MOEDA2_LOGFILE" 2>> "$ERROR_LOGFILE" &

PID2=$!
echo "$(date): SRBMiner Moeda 2 iniciado com PID: $PID2 (CPUs: $AFFINITY2)" >> "$ENV_LOGFILE"

# ============================================================================
# MONITORAMENTO E VERIFICAÇÃO DE CPU AFFINITY
# ============================================================================

echo "$(date): Ambos mineradores iniciados com sucesso!" >> "$ENV_LOGFILE"

# Verificar affinity após inicialização
sleep 10
echo "$(date): Verificando CPU affinity..." >> "$ENV_LOGFILE"

# Função para verificar affinity e uso de CPU
check_affinity() {
    echo "$(date): === VERIFICAÇÃO DE AFFINITY ===" >> "$ENV_LOGFILE"
    
    # Verificar affinity do Minerador 1
    if taskset -cp $PID1 > /dev/null 2>&1; then
        AFF1=$(taskset -cp $PID1 2>/dev/null | cut -d: -f2 | xargs)
        echo "$(date): Minerador 1 (PID $PID1) affinity: $AFF1" >> "$ENV_LOGFILE"
    else
        echo "$(date): ❌ Não foi possível verificar affinity do Minerador 1" >> "$ERROR_LOGFILE"
    fi
    
    # Verificar affinity do Minerador 2
    if taskset -cp $PID2 > /dev/null 2>&1; then
        AFF2=$(taskset -cp $PID2 2>/dev/null | cut -d: -f2 | xargs)
        echo "$(date): Minerador 2 (PID $PID2) affinity: $AFF2" >> "$ENV_LOGFILE"
    else
        echo "$(date): ❌ Não foi possível verificar affinity do Minerador 2" >> "$ERROR_LOGFILE"
    fi
    
    # Uso de CPU por core
    echo "$(date): Uso de CPU por core:" >> "$ENV_LOGFILE"
    mpstat -P ALL 1 1 | grep -E "(CPU|Average)" >> "$ENV_LOGFILE" 2>/dev/null || \
    echo "$(date): Comando mpstat não disponível" >> "$ENV_LOGFILE"
}

# Verificação inicial
check_affinity

# Função para verificar se os processos estão ativos
check_processes() {
    if kill -0 $PID1 2>/dev/null; then
        echo "$(date): ✅ Minerador 1 (PID $PID1) ativo" >> "$ENV_LOGFILE"
    else
        echo "$(date): ❌ Minerador 1 (PID $PID1) parou" >> "$ERROR_LOGFILE"
    fi
    
    if kill -0 $PID2 2>/dev/null; then
        echo "$(date): ✅ Minerador 2 (PID $PID2) ativo" >> "$ENV_LOGFILE"
    else
        echo "$(date): ❌ Minerador 2 (PID $PID2) parou" >> "$ERROR_LOGFILE"
    fi
}

# Monitoramento contínuo
while true; do
    if kill -0 $PID1 2>/dev/null && kill -0 $PID2 2>/dev/null; then
        sleep 30
        check_processes
        # Verificar affinity a cada 2 minutos
        if [ $(( $(date +%s) % 120 )) -eq 0 ]; then
            check_affinity
        fi
    else
        echo "$(date): Um ou ambos mineradores pararam" >> "$ERROR_LOGFILE"
        break
    fi
done

# Aguardar ambos os processos
echo "$(date): Aguardando finalização dos processos..." >> "$ENV_LOGFILE"
wait $PID1 $PID2

echo "$(date): Ambos mineradores finalizaram." >> "$ENV_LOGFILE"